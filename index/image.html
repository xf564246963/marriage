<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        html, body, #container {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        img {
            height: 100%;
            width: 100%;
            display: none;
        }

    </style>
    <script src="./js/Tween.js"></script>
    <script src="./js/flowers.js"></script>
</head>
<body>
<div id="container">
    <canvas id="canvas">
        Your browser does not support the HTML5 canvas tag.
    </canvas>
</div>
<script>
    var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
            window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;

    var cancelAnimationFrame = window.cancelAnimationFrame || window.mozCancelAnimationFrame;

    var img_list = [];
    for(var i = 1; i <= 5; i++ ){
        img_list.push(i);
    }
    var imgListLen = img_list.length;

    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    ctx.save();
    var scale = 1;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    var offsetCanvas = document.createElement('canvas');
    var offsetCanvasCtx = offsetCanvas.getContext('2d');
    offsetCanvas.width = window.innerWidth;
    offsetCanvas.height = window.innerHeight;

    function imgResponse(imgArr){
        for(var i = 0; i <= imgListLen; i++ ){
            if(Object.prototype.toString.call(imgArr[i])==="[object Object]"){
                var img = imgArr[i].imageObject;
                imgArr[i].imgClipData = {};
                //canvas drawImage自适应
                if(img.width/img.height>=window.innerWidth/window.innerHeight){
                    imgArr[i].imgClipData.width = parseInt(img.height*window.innerWidth/window.innerHeight);
                    imgArr[i].imgClipData.height = img.height;
                    imgArr[i].imgClipData.x = (img.width-imgArr[i].imgClipData.width)/2;
                    imgArr[i].imgClipData.y = 0;
                }else{
                    imgArr[i].imgClipData.width = img.width;
                    imgArr[i].imgClipData.height = parseInt(img.width/window.innerWidth*window.innerHeight);
                    imgArr[i].imgClipData.x = 0;
                    imgArr[i].imgClipData.y = (img.height-imgArr[i].imgClipData.height)/2;
                }

                //canvas background 自适应
//                    if(img.width/img.height>=window.innerWidth/window.innerHeight){
//                        imgArr[i].imgClipData.width = parseInt(window.innerHeight*img.width/img.height);
//                        imgArr[i].imgClipData.height = window.innerHeight;
//                        imgArr[i].imgClipData.x = -(imgArr[i].imgClipData.width-window.innerWidth)/2;
//                        imgArr[i].imgClipData.y = 0;
//                    }else{
//                        imgArr[i].imgClipData.width = window.innerWidth;
//                        imgArr[i].imgClipData.height = parseInt(window.innerWidth*img.height/img.width);
//                        imgArr[i].imgClipData.x = 0;
//                        imgArr[i].imgClipData.y = -(imgArr[i].imgClipData.height-window.innerHeight)/2;
//                    }
            }
        }
    }

    function imgResponseAsBg(imgArr){
        var bgArr = [];
        for(var i = 0; i <= imgListLen; i++ ){
            if(Object.prototype.toString.call(imgArr[i])==="[object Object]"){
                var img = imgArr[i].imageObject;
                bgArr[i] = {};
                bgArr[i].imageObject = img;
                bgArr[i].imgClipData = {};
                //canvas background 自适应
                if(img.width/img.height>=window.innerWidth/window.innerHeight){
                    bgArr[i].imgClipData.width = parseInt(window.innerHeight*img.width/img.height);
                    bgArr[i].imgClipData.height = window.innerHeight;
                    bgArr[i].imgClipData.x = -(bgArr[i].imgClipData.width-window.innerWidth)/2;
                    bgArr[i].imgClipData.y = 0;
                }else{
                    bgArr[i].imgClipData.width = window.innerWidth;
                    bgArr[i].imgClipData.height = parseInt(window.innerWidth*img.height/img.width);
                    bgArr[i].imgClipData.x = 0;
                    bgArr[i].imgClipData.y = -(bgArr[i].imgClipData.height-window.innerHeight)/2;
                }
            }
        }
        return bgArr;
    }

    function loadImg(imgArr, callback){
        var len=imgArr.length;
        if(len<=0)return callback(1,[]);
        var loaded=0;var imgList=[];
        var loadFun=function(evt){
            var type={
                "load": 1,
                "error": 2
            }[evt.type];
            if(type === 1){
                if(loaded<len){
                    ++loaded;
                    callback(loaded/len,imgList);
                }
            }else{
                this.src = this.src;
            }
        };
        for (var i = 0; i < len; i++) {
            imgList[i] = {};
            imgList[i].imageObject = new Image;
            imgList[i].imageObject.onload = function () {
                loadFun.call(this, {
                    type: "load"
                })
            };
            imgList[i].imageObject.onerror = function () {
                loadFun.call(this, {
                    type: "error"
                })
            };
            imgList[i].imageObject.src = imgArr[i];
        }
    };

    var imageDrawerArr = [],bgArr;

    document.addEventListener("DOMContentLoaded",function(){

        for(var j=0; j<imgListLen; j++){
            img_list[j] = './image/'+img_list[j]+".jpg";
        }

        loadImg(img_list,function (o, imgObjectList) {
            if(o === 1){


                imgResponse(imgObjectList);
                bgArr = imgResponseAsBg(imgObjectList);

                Transform.init(ctx);
                pageManage.init(ctx);
                RENDERER.init(canvas,ctx);

                var num = 1;

                for(var i = 0; i < imgObjectList.length; i++){
                    var img = imgObjectList[i];
                    imageDrawerArr.push(new ImageDrawer(img.imageObject,img.imgClipData, ctx));
                }

                pageManage.animateInit(0);


            }
        });
    })



    //图像实例
    function ImageDrawer(imageObject,imgClipData,context){
        this.context = context;
        this.imageObject = imageObject;
        this.imgClipData = imgClipData;
    }
    ImageDrawer.prototype = {
        setParam:function(){

        },
        draw:function(){
            this.context.drawImage(this.imageObject, this.imgClipData.x,
                    this.imgClipData.y, this.imgClipData.width,
                    this.imgClipData.height, 0, 0, window.innerWidth, window.innerHeight);
        },
        drawInOffsetCanvas:function(){
            offsetCanvasCtx.drawImage(this.imageObject, this.imgClipData.x,
                    this.imgClipData.y, this.imgClipData.width,
                    this.imgClipData.height, 0, 0, window.innerWidth, window.innerHeight);
            return offsetCanvas;
        }
    }


    //变形方法
    var Transform = {
        init:function(context){
            this.context = context;
        },
        translate: function (x, y) {
            this.context.translate(x, y);
        },
        scale: function (scale) {
            var scaleObj = {};
            if (Object.prototype.toString.call(scale) === "[object Object]") {
                scaleObj = scale;
            } else if (Object.prototype.toString.call(scale) === "[object Number]") {
                scaleObj = {
                    x: scale,
                    y: scale
                }
            }
            var translateX = window.innerWidth / 2;
            var translateY = window.innerHeight / 2;

            this.context.translate(translateX, translateY);

            this.context.scale(scaleObj.x, scaleObj.y);

            this.context.translate(-translateX, -translateY);

        }
    }

    var pageManage = {
        //每页动画处理逻辑
        "0":function(){
            this.pageData[this.pageIndex].scale.x = this.pageData[this.pageIndex].scale.x - 0.01;
            this.pageData[this.pageIndex].scale.y = this.pageData[this.pageIndex].scale.y - 0.01;
            Transform.scale(this.pageData[this.pageIndex].scale.x,this.pageData[this.pageIndex].scale.y);
            imageDrawerArr[this.pageIndex].draw();
            if(this.pageData[this.pageIndex].scale.x<=0 || this.pageData[this.pageIndex].scale.y<=0){
                this.animateStop();
                this.pageData[this.pageIndex].scale = { x:1, y:1 };
                this.animateInit(this.pageIndex+1);
            }
        },
        "1":function(){
            this.pageData[this.pageIndex].x+=4;
            Transform.translate(this.pageData[this.pageIndex].x,0);
            imageDrawerArr[this.pageIndex].draw();
            if(this.pageData[this.pageIndex].x>=window.innerWidth){
                this.animateStop();
                this.pageData[this.pageIndex].x = 0;
                this.animateInit(this.pageIndex+1);
            }
        },
        "2":function(){
            this.pageData[this.pageIndex].y+=8;
            Transform.translate(0,this.pageData[this.pageIndex].y);
            imageDrawerArr[this.pageIndex].draw();
            if(this.pageData[this.pageIndex].y>=window.innerHeight){
                this.animateStop();
                this.pageData[this.pageIndex].y=0;
                this.animateInit(this.pageIndex+1,this.flowerPage);
                this.pageData[this.flowerPage].startTime = new Date().getTime();
            }
        },
        "3":function(){
            RENDERER.render();
            var endTime = new Date().getTime();
            if(this.pageData[this.flowerPage].startTime != null && endTime - this.pageData[this.flowerPage].startTime > 5000){
                this.animateStop();
                this.startTime = null;
                this.animateInit(this.pageIndex+1);
                RENDERER.init(canvas,ctx);
            }
        },
        "4":function(){

        },
        pageData:{
            "0":{
                scale:{ x:1, y:1 }
            },
            "1":{
                x: 0
            },
            "2":{
                y: 0
            },
            "3":{
                startTime:null
            }
        },
        timer:null,
        flowerPage:3,
        maxPageIndex:4,
        pageIndex:0,
        animate:function(){
            this.timer = requestAnimationFrame(this.animate.bind(this));
            ctx.save();
            ctx.clearRect(0,0,window.innerWidth*2,window.innerHeight*2);
            pageManage[this.pageIndex+""]();
            ctx.restore();
        },
        animateInit:function(index,bgIndex){
            if(index === undefined || index === null){
                this.pageIndex++;
            }else{
                this.pageIndex = index;
            }
            this.restore();
            imageDrawerArr[this.pageIndex].draw();
            if(bgIndex === undefined || bgIndex === null){
                bgIndex = this.pageIndex + 1;
                if(bgIndex>this.maxPageIndex){
                    bgIndex = 0
                }
            }
            this.setBg(bgIndex);
            setTimeout(function(){
                requestAnimationFrame(this.animate.bind(this));
            }.bind(this),200)
        },
        animateStop:function(){
            cancelAnimationFrame(this.timer);
        },
        setBg:function(index){
            document.querySelector("#container").style.background = "url("+img_list[index]+") no-repeat "
                    +bgArr[index].imgClipData.x+"px "+bgArr[index].imgClipData.y +"px/"
                    +bgArr[index].imgClipData.width+"px " +bgArr[index].imgClipData.height+"px";
        },
        init:function(context){
            this.context = context;
        },
        restore:function(){
            this.context.restore();
            this.context.resetTransform();
            this.context.save();
        }
    }


</script>
</body>
</html>